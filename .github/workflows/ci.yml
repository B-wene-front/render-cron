name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  NODE_VERSION: '22'

jobs:
  # Job 1: Lint and Type Check
  test:
    name: Test & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine project directory
        id: project
        run: |
          if [ -d "render-cron" ]; then
            echo "dir=render-cron" >> $GITHUB_OUTPUT
            echo "lockfile=render-cron/package-lock.json" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
            echo "lockfile=package-lock.json" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ steps.project.outputs.lockfile }}
      
      - name: Install dependencies
        working-directory: ${{ steps.project.outputs.dir }}
        run: npm ci
      
      - name: Type check
        working-directory: ${{ steps.project.outputs.dir }}
        run: npm run type-check
      
      - name: Build
        working-directory: ${{ steps.project.outputs.dir }}
        run: npm run build

  # Job 2: Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Determine build context
        id: context
        run: |
          if [ -d "render-cron" ]; then
            echo "context=render-cron" >> $GITHUB_OUTPUT
            echo "dockerfile=render-cron/Dockerfile" >> $GITHUB_OUTPUT
          else
            echo "context=." >> $GITHUB_OUTPUT
            echo "dockerfile=./Dockerfile" >> $GITHUB_OUTPUT
          fi
      
      - name: Build Docker image
        run: |
          docker build -t evtol-news-service:test \
            -f ${{ steps.context.outputs.dockerfile }} \
            ${{ steps.context.outputs.context }}
      
      - name: Test Docker image
        run: |
          docker run -d -p 3000:3000 --name test-container \
            -e PORT=3000 \
            -e API_SECRET=test-secret \
            -e SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            -e SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }} \
            -e VOYAGEAI_API_KEY=${{ secrets.VOYAGEAI_API_KEY }} \
            evtol-news-service:test
          
          # Wait for service to start
          sleep 10
          
          # Test health endpoint
          curl -f http://localhost:3000/health || exit 1
          
          # Cleanup
          docker stop test-container
          docker rm test-container

  # Job 3: Deploy to Render (on main/master branch)
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [test, docker-build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger Render Deployment
        run: |
          echo "âœ… CI checks passed. Render will auto-deploy from Git."
          echo "If you have Render webhook configured, deployment will start automatically."
          echo "Otherwise, go to Render dashboard and manually trigger deployment."
      
      # Optional: If you want to use Render API to trigger deployment
      # - name: Trigger Render Deployment via API
      #   run: |
      #     curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
      #       -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
      #       -H "Content-Type: application/json"

